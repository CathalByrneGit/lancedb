# lancedb

R package for [LanceDB](https://lancedb.com/) — an embedded vector database for AI applications.

Built on **Rust bindings** via [extendr](https://extendr.github.io/), with a **lazy query API** that interoperates with **dplyr verbs** (`filter`, `select`, `arrange`, `slice_head`, `collect`). Queries build a plan; nothing executes until `collect()`.

## Installation

Requires Rust toolchain (cargo >= 1.70).

```r
# Install from source (development)
# install.packages("remotes")
remotes::install_github("lancedb/lancedb", subdir = "r")
```

## Quick Start

```r
library(lancedb)
library(dplyr)

# Connect to a local database
con <- lancedb_connect("/tmp/my_lancedb")

# Create a table from a data.frame
df <- data.frame(
  id    = 1:100,
  name  = paste0("item_", 1:100),
  score = runif(100),
  vec   = I(lapply(1:100, function(i) rnorm(4)))
)
tbl <- lancedb_create_table(con, "items", df)

# Full table scan with dplyr verbs
results <- lancedb_scan(tbl) %>%
  filter(score > 0.5) %>%
  select(id, name, score) %>%
  slice_head(n = 10) %>%
  collect()

print(results)
```

## Vector Search

```r
# Search by vector similarity
query_vec <- rnorm(4)

results <- lancedb_search(tbl, query_vec) %>%
  filter(score > 0.3) %>%
  select(id, name, score) %>%
  slice_head(n = 5) %>%
  collect()
```

## API Reference

### Connection

| Function | Description |
|---|---|
| `lancedb_connect(uri)` | Connect to a LanceDB database (local path or cloud URI) |

### Table Operations

| Function | Description |
|---|---|
| `lancedb_create_table(con, name, data, mode)` | Create a new table from a data.frame or Arrow Table |
| `lancedb_open_table(con, name)` | Open an existing table |
| `lancedb_count_rows(table, filter)` | Count rows (optionally with a filter) |
| `lancedb_add(table, data, mode)` | Add data to an existing table |
| `lancedb_delete(table, predicate)` | Delete rows matching a predicate |

### Query Constructors

| Function | Description |
|---|---|
| `lancedb_search(table, query_vector)` | Start a lazy vector similarity search |
| `lancedb_scan(table)` | Start a lazy full table scan |

### dplyr Verbs (on `lancedb_lazy` objects)

| Verb | Description |
|---|---|
| `filter(.data, ...)` | Add a WHERE clause (R expressions or strings) |
| `select(.data, ...)` | Choose columns to return |
| `slice_head(.data, n)` | Limit number of results |
| `arrange(.data, ...)` | Order results (backend-dependent) |
| `collect(x, as)` | Execute the query and return results |
| `pull(.data, var)` | Execute and extract a single column |
| `head(x, n)` | Alias for `slice_head(n = ...)` |

### Utilities

| Function | Description |
|---|---|
| `show_query(x)` | Display the query plan |

## Filter Expressions

Filters can be R expressions or raw strings:

```r
# R expression — translated automatically
lancedb_scan(tbl) %>% filter(age > 30, name == "Alice")

# String filter — passed directly to LanceDB
lancedb_scan(tbl) %>% filter("age > 30 AND name = 'Alice'")
```

### Supported R expression syntax

| R | LanceDB |
|---|---|
| `==` | `=` |
| `!=` | `!=` |
| `>`, `>=`, `<`, `<=` | same |
| `&` | `AND` |
| `|` | `OR` |
| `!` | `NOT` |
| `%in% c(...)` | `IN (...)` |
| `is.na(x)` | `x IS NULL` |
| `between(x, lo, hi)` | `x BETWEEN lo AND hi` |
| `stats$strength` | `stats.strength` |

## Python Comparison

The R API mirrors the Python LanceDB query builder:

**Python:**
```python
table.search(qvec)
  .where("stats.strength > 3")
  .select(["name", "role", "description"])
  .limit(5)
  .to_pandas()
```

**R:**
```r
lancedb_search(tbl, qvec) %>%
  filter(stats$strength > 3) %>%
  select(name, role, description) %>%
  slice_head(n = 5) %>%
  collect()
```

## Architecture

```
R/                    S3 classes + dplyr methods
src/rust/             Rust bindings (extendr + lancedb crate)
tests/testthat/       Unit tests
man/                  Documentation (generated by roxygen2)
```

The package uses a lazy evaluation model inspired by dbplyr:

1. `lancedb_search()` or `lancedb_scan()` creates a `lancedb_lazy` object
2. dplyr verbs (`filter`, `select`, `slice_head`) append operations to the plan
3. `collect()` serializes the plan, sends it to Rust, executes against LanceDB, and returns results via Arrow IPC

All verb calls return **new** `lancedb_lazy` objects — the original is never mutated.

## Return Formats

```r
# Default: data.frame
df <- lancedb_scan(tbl) %>% collect()

# Arrow Table
arrow_tbl <- lancedb_scan(tbl) %>% collect(as = "arrow")
```

## Requirements

- R >= 4.0
- Rust >= 1.70 (for building from source)
- System dependencies: same as the `arrow` R package

## License

Apache License 2.0
